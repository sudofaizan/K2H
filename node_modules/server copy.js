const fs = require("fs");
const WebSocket = require("ws");
const { PassThrough } = require("stream");
const ffmpeg = require("fluent-ffmpeg");

// WebSocket Server
const wss = new WebSocket.Server({ port: 8080 });

wss.on("connection", (ws) => {
  console.log("Client connected");

  const rawStream = fs.createWriteStream("raw.webm"); // Save raw WebSocket data
  const audioStream = new PassThrough();

  ffmpeg(audioStream)
    .inputFormat("webm") // Input format is WebM
    .audioCodec("libmp3lame") // Convert to MP3
    .format("wav") // Output MP3 format
    .on("start", (cmd) => console.log("FFmpeg command:", cmd))
    .on("error", (err) => console.error("FFmpeg error:", err.message))
    .on("end", () => console.log("Audio conversion finished"))
    .pipe(fs.createWriteStream("output.wav"));

  ws.on("message", (data) => {
    console.log("Received data chunk size:", data.length);
    rawStream.write(data); // Save raw data
    audioStream.write(data); // Send data to FFmpeg
  });

  ws.on("close", () => {
    console.log("Client disconnected");
    rawStream.end();
    audioStream.end();
  });
});

console.log("WebSocket server running on ws://localhost:8080");